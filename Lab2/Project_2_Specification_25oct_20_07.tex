\documentclass{article}
\usepackage{zed-csp}
%\input{handout}

\begin{document}
	
	There are several state variables that will describe state of the pump:\\
	\\
	
	ALARMSTATE: Is alarm activated, silenced or turned off\\
	PARAMSSTATE: Are parameters set or not set\\
	UNITLOCKSTATE: Is unit locked or unlocked \\
	LINESLOCKSTATE: Is line locked, unlocked, hooked up or hooked out\\
	PUMPSTATUS: Current status of the pump (pump or not pump)\\
	ERRORSTATUS: Status of the possible pump error during the lifetime\\
	LINESTATUS: Status of the line events
	POWERMODE: Possible states of the power
	
	\begin{zed}	
		
		
		ALARMSTATE ::= activated | silenced | alarm\_off \\
		
		[PARAMSSTATE] \\ %Assumption: powerset of all settings
	
		UNITLOCKSTATE ::= unit\_locked | unit\_unlocked \\
	
		PUMPSTATUS ::= pump\_on | pump\_off | pump\_active \\
		
		PUMPPLUG ::=  plug\_in | plug\_off
		
		ERRORSTATUS ::= ok | end\_of\_treatment\_time | post\_error | system\_check\_error \\ | run\_out\_medicine | low\_battery | line\_issue \\
		
		LINESTATUS :: = line\_locked | line\_unlocked \\
		
		POWERMODE ::= electricity | battery | low\_battery | empty\_battery \\
	\end{zed}
	
	//Problem - we can have only one state
	
	\begin{schema}{Line}
		fluid: \nat \\
		rate: \nat \\
		line\_status: LINESTATUS \\
		line\_error: LINEERROR
	\where
		fluid \leqslant 500 \\ 
		rate \leqslant 25
	\end{schema}
	
	\begin{zed}
		ID::=1|2|3
	\end{zed}
	Pump has only three inputs. We defined it by setting ennumeration ID by this way.	
	\begin{schema}{Pump}
		lines : ID \pfun Line \\
		alarmstate : ALARMSTATE \\
		unitstate : UNITLOCKSTATE \\
		powermode : POWERMODE \\
		pumpplug : PUMPPLUG \\
		status: PUMPSTATUS \\
		paramset: PARAMSSTATE
	\where
		\# \ran lines = \# \dom lines \\
		pumpplug = plug\_off \implies powermode \neq electricity 
	\end{schema}
	
	Assumption: when pump would became to the state plugoff, powermode would automatically became to the status $battery$.\\
	
	At the beginning pump has no lines plugged in and powered of.
	Unit is unlocked. Alarm is not sound. 
		
	
	\begin{schema}{InitPump}
		Pump
		\where
		lines = \emptyset \\
		alarmstate = off \\
		unitstate  = unit\_unlocked \\
		powermode =  no\_power \\
		pumpplug = plug\_off \\
		status = pump\_off\\
		param\_set = not\_set	
	\end{schema}
	
	\begin{schema}{InitLine}
		Line
		\where
		fluid = 500 \\
		rate = 0 \\
		line\_status = line\_unlocked\\
		line\_error = ok \\
	\end{schema}

	Dataframe
	\begin{schema}{PumpOp}
		\Delta Pump
	\where
    	lines' = lines  \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
    	pumpplug' = pumpplug
    	status' = status \\
    \end{schema}
	

	Level of abstraction set + Assumption + Valid paramset?\\
	ADD set of satisfaibale parmset!!!!!!!!!!!!!!!!!!!!!!!!!!

	\begin{schema}{SetParam}
		PumpOp \\
		paramst? : PARAMSSTATE 
	\where
		status = pump\_on \\ 
		unitstate = unit\_unlocked \\
		paramset' = paramset?
	\end{schema}

	
    \begin{schema}{UnitLockUnlock}
		\Delta Pump \\
		new\_unitstate? : LINELOCKSTATE
	\where
		status \neq pump\_off \\ 
		unitstate \neq new\_unitstate? \\
		unitstate' = new\_unitstate? \\
    	lines' = lines  \\
    	paramset' = paramset\\
    	alarmstate' = alarmstate \\
    	powermode' = powermode \\
    	pumpplug' = pumpplug \\
    	status' = status \\	
	\end{schema}
	Assumption: couldn't lock/unlock while off mode, because screen and buttons are inactive.

	

    \begin{schema}{AddLineLock}
		\Delta Pump \\
		\Delta Line \\
		id1? : ID \\
		line? : Line \\
	\where
	    status \neq pump\_active \\
		id1? \notin \dom lines \\
		line?.line\_status = line\_unlocked \\
		line?.line\_error = ok\\
    	lines' = lines \cup \{id1? \mapsto line?\} \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
    	pumpplug' = pumpplug \\
    	status' = status \\
    	paramset' = paramset

	\end{schema}
	For adding new line pump shouldnot be in active status.\\
    By this operation we add new line and automatically lock it. ARTUR check the dote after line?
	

	\begin{schema}{LineUnlock}
		\Delta Pump \\
		id1? : ID \\
	\where
		 status \neq pump\_active \\
		id1? \in \dom lines \\
		lines' = lines \setminus \{id1? \mapsto lines(id1?)\} \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
    	pumpplug' = pumpplug \\
    	status' = status \\
    	paramset' = paramset
	\end{schema}
	To unlock(exclude) the line from pump, pump couldnot be in active mode.

	\begin{schema}{RefillLineMedicine}
		\Delta Line \\
	\where
	    fluid' = 500 \\
	    line\_status' = line\_status \\
		line\_error' = line\_error \\
		rate'=rate
	\end{schema}
	Assumption: We could refill pump medicine by setting new package, which would be full of medicine. As a result if we refill fluid would become 500.
	
	
	\begin{schema}{PlugOff}
		\Delta Pump		
	\where
		pumpplug = plug\_in \\		
		lines' = lines  \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
    	pumpplug' = plug\_off \\
    	status' = status \\		
		paramset' = paramset		
	\end{schema}
	Powermode would automatically change according to invariant.
	\begin{schema}{PlugIn}
		\Delta Pump 
	\where
		pumpplug = plug\_off \\
		lines' = lines  \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
    	pumpplug' = plug\_in \\
    	powermode' = electricity \\
		status' = status \\
		paramset' = paramset		
	\end{schema}
    Assumption: If pump before plugging in worked from battery, after plugging in it automatically would start work from electricity. However, you can switch to the battery later. CHECK????????????	
	\begin{schema}{SwitchToBattery}
		\Delta Pump \\
	\where 
		status \neq pump\_off \\
		powermode \neq battery\\
		lines' = lines \\
		alarmstate' = alarmstate \\
		unitstate' = unitstate \\
		powermode' = battery \\
		status' = status \\
		paramset' = paramset \\
	\end{schema}
	
	\begin{schema}{SwitchToElectricity}
		\Delta Pump \\
	\where 
		status \neq pump\_off \\
		pumpplug = plug\_in \\
		powermode \neq electricity \\
		lines' = lines \\
		status' = status \\
		alarmstate' = alarmstate \\
		unitstate' = unitstate \\
		powermode' = electricity \\
		paramset' = paramset \\
	\end{schema}
	
	Power mode can be switched to the electricity when pump plugged in to socket.

	\begin{schema}{SetPumpOn}
		\Delta Pump \\
	\where 
		status \neq pump\_on \\
		status' = pump\_on \\
		lines' = lines \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
		paramset' = paramset
	\end{schema}
	
	This action can be used to switch pump from active state to enabled state (pump\_on) and from off state to enabled state (pump\_on).
	
	\begin{schema}{StartPump}
		\Delta Pump
	\where
		status = pump\_on \\ 
		status' = pump\_active \\
		lines' = lines  \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
		paramset' = paramset
	\end{schema}
	
	This action can be used to switch pump from enabled state (pump\_on) to active state.
	
	\begin{schema}{StopPump}
		\Delta Pump
	\where
		status = pump\_on \\ 
		status' = pump\_off \\
		lines' = lines  \\
    	alarmstate' = alarmstate \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
		paramset' = paramset
	\end{schema}	
			
	This action can be used to switch pump from enabled state (pump\_on) to off state. Electrical failure is out of scope in that case, it was described 
	in plug_out action. Assumption is battery cannot be empty.		
			
	\begin{schema}{SystemCheck}
		\Delta Pump\\
		report!:PUMPERROR
	\where 
		status? = system\_check\_error \lor system\_check\_pass \\
		status? \neq status\\
		status' = status?
	\end{schema}
	
	
	Pushing fluids through the particular pump line (add frame) alarm is a pump status, how to obtain it from
	
	\begin{schema}{PushFluidsPromote}
		\Delta Pump	\\
		\Delta Line \\
		id1? : ID \\
	\where 
		id1? \in activeids \\
		(lines id1?) = \theta Line \\
		lines' = lines \oplus \{id1? -> \theta Line'\} \\		
	\end{schema}
	
	//Add alarm here + runoutofmedicene
	\begin{schema}{PushFluids}
		\Delta Line \\
		amount?: \nat \\
		status?: LINESTATUS
	\where 
		fluid > what? \\
		fluid' = fluid - amount? \\
		line_status' = LINESTATUS
	\end{schema}

\end{document}
