\documentclass{article}
\usepackage{zed-csp}
%\input{handout}

\begin{document}
	
	There are several state variables that will describe state of the pump:\\
	\\
	
	ALARMSTATE: Is alarm activated, silenced or turned off\\
	PARAMSSTATE: Are parameters set or not set\\
	UNITLOCKSTATE: Is unit locked or unlocked \\
	LINESLOCKSTATE: Is line locked, unlocked, hooked up or hooked out\\
	PUMPSTATUS: Current status of the pump (pump or not pump)\\
	ERRORSTATUS: Status of the possible pump error during the lifetime\\
	LINESTATUS: Status of the line events
	POWERMODE: Possible states of the power
	
	\begin{zed}	
		
		
		ALARMSTATE ::= activated | silenced | alarm\_off \\
		
		PARAMSSTATE ::= set | not\_set \\
	
		UNITLOCKSTATE ::= unit\_locked | unit\_unlocked \\
	
		LINESLOCKSTATE ::= lines\_locked | lines\_unlocked | line\_hooked\_up | line\_hooked\_out \\
		PUMPSTATUS ::= pump\_on | pump\_off \\		
		
		ERRORSTATUS ::= ok | end\_of\_treatment\_time | post\_error | system\_check\_error \\ | run\_out\_medicine | low\_battery | line\_issue \\
		
		LINESTATUS ::= ok | med\_ended | pinched | plugged \\
		
		POWERMODE ::= electricity | battery | low\_battery | empty\_battery \\
	\end{zed}
	
	//Problem - we can have only one state
	
	\begin{schema}{Line}
		fluid: \nat \\
		line\_status: LINESTATUS	
	\end{schema}
	
	\begin{zed}
		ID::=1|2|3
	\end{zed}
		
	\begin{schema}{Pump}
		activeids : \power ID\\
		lines : ID \pfun Line \\
		alarmstate : ALARMSTATE \\
		linelockstate : LOCKSTATE \\
		unitstate : UNITLOCKSTATE \\
		powermode : POWERMODE \\
		status: PUMPSTATUS\\
		paramset:PARAMSSTATE
	\where
		\# \ran lines \leq 3\\
		\# \ran lines = \# \dom lines\\
		\dom lines = activeids\\
	\end{schema}
	
	At the beginning pump has no lines plugged in and powered of.
	Unit and lines state is unlock. Alarm is not sound. 
	Pump has three inputs.	
	
	\begin{schema}{InitPump}
		Pump
		\where
		%вопрос line
		%line : \power Line \\
		%вопрос line
		%lines : \nat \pfun Line \\
		activeids = \emptyset \\
		lines = \emptyset \\
		alarmstate = off \\
		linelockstate = unlocked \\
		unitstate  = unlocked \\
		powermode =  no\_power \\
		status = pump\_off\\
		param\_set=not\_set	
	\end{schema}
	
	Dataframe
	\begin{schema}{PumpOp}
		\Delta Pump
	\where
    	activeids' = activeids \\
    	lines' = lines  \\
    	alarmstate' = alarmstate \\
    	linelockstate' = linelockstate  \\
    	unitstate' = unitstate \\
    	powermode' = powermode \\
    	status' = status \\
    \end{schema}
	
	\begin{schema}{SetParam}
		PumpOp \\
		paramst? : PARAMSSTATE 
	\where
		status = pump\_on \\ 
		unitstate = unit\_unlocked \\
		paramset' = paramset?
	\end{schema}

    \begin{schema}{LineLockUnlock}
		\Delta Pump \\
		new\_linestate? : LINELOCKSTATE
	\where
		status = pump\_on \\ 
		unitstate \neq new\_unitstate? \\
		unitstate' = new\_unitstate? \\		
	\end{schema}
	
    \begin{schema}{UnitLockUnlock}
		\Delta Pump \\
		new\_unitstate? : UNITLOCKSTATE
	\where
		status = pump\_on \\ 
		unitstate \neq new\_linestate? \\
		unitstate' = new\_linestate? \\
	\end{schema} 	
	
	When we adding a new line, the id parameter identifies number of 
	one of the three input inside of the infusion pump.

	\begin{schema}{LineHookUp}
		\Delta Pump \\
		id1? : ID \\
		line? : Line \\
	\where
		id1? \notin activeids \\
		\# lines \leq 2 \\
		linelockstate = lines\_unlocked \\
		status' = status \\
		alarmstate' = alarmstate \\
		linelockstate' = linelockstate \\
		powermode' =  powermode \\
		unitstate' = unitstate \\
		lines' = lines \cup \{id1? \mapsto line?\} \\
		activeids' = activeids \cup id1?
	\end{schema}

	When we removing a line from the pump, it should have unlock state
	and also have id parameter which identifies number of one of the
	three input of the infusion pump.
	
	\begin{schema}{LineHookOut}
		\Delta Pump \\
		id1? : ID \\
		line? : Line
	\where
		id1? \in activeids \\
		\# lines \geq 1 \\
		linelockstate = lines_unlocked \\
		status' = status \\
		alarmstate' = alarmstate \\
		linelockstate' = linelockstate \\
		powermode' =  powermode \\
		unitstate' = unitstate \\
		lines' = lines \setminus \{id1? \mapsto line?\} \\
		activeids' = activeids \setminus id1?
	\end{schema}
	
	\begin{schema}{RefillMedicine}
		\Delta Pump \\
		\Delta Line \\
		id1? : ID \\
		line? : Line
	\where
		\# lines \geq 1 \\
		linelockstate = lines_unlocked \\
		status' = status \\
		alarmstate' = alarmstate \\
		linelockstate' = linelockstate \\
		powermode' =  powermode \\
		unitstate' = unitstate \\
		lines' = lines \setminus \{id1? \mapsto line?\} \\
		activeids' = activeids \setminus id1?
	\end{schema}
	
	To start working with the pump we removing a line from the pump, it should have unlock state
	and also have id parameter which identifies number of one of the
	three input of the infusion pump.	
	
	\begin{schema}{PlugIn}
		\Delta Pump\\
		status?:PUMPSTATUS
	\where
		status? = plug\_in \\
		status = plug\_out \\
		status' = status? \\
		alarmstate' = alarmstate \\
		linelockstate' = linelockstate \\
		powermode' =  electricity \\
		unitstate' = unitstate \\
	\end{schema}
	
	//Does this action covers the case when we lost electricity?
	
	\begin{schema}{PlugOut}
		\Delta Pump\\
		status?:PUMPSTATUS
	\where
		status? = plug\_out \\
		status = plug\_in \\
		status' = status? \\
		alarmstate' = alarmstate \\
		linelockstate' = linelockstate \\
		powermode' =  battery \\
		unitstate' = unitstate \\
	\end{schema}
	
	// Can pump be pugged out and powermode is battery?	
	
	\begin{schema}{SwitchToBattery}
		\Delta Pump\\
		mode?:POWERMODE
	\where 
		mode? = battery \\
		mode = elictricity \\
		status = plug\_in \\
		powermode' = mode? \\
		status' = status \\
		alarmstate' = alarmstate \\
		linelockstate' = linelockstate \\
		unitstate' = unitstate \\
	\end{schema}
	
	%Power On Self Test
	\begin{schema}{TurnOn}
		\Delta Pump \\
		status?:PUMPSTATUS
	\where 
		status? = post\_error  \\
		status? = plug\_on \\
		status' = status?
	\end{schema}
			
	\begin{schema}{SystemCheck}
		\Delta Pump\\
		status?:PUMPSTATUS
	\where 
		status? = system\_check\_error \lor system\_check\_pass \\
		status? \neq status\\
		status' = status?
	\end{schema}
	
	Pushing fluids through the particular pump line (add frame) alarm is a pump status, how to obtain it from
	
	\begin{schema}{PushFluidsPromote}
		\Delta Pump	\\
		\Delta Line \\
		id1? : ID \\
		status?: LINESTATUS
	\where 
		id1? \in activeids \\
		(lines id1?) = \theta Line \\
		lines' = lines \oplus \{id1? -> \theta Line'\} \\		
	\end{schema}
	
	//Add alarm here + runoutofmedicene
	\begin{schema}{PushFluids}
		\Delta Line \\
		amount?: \nat \\
		status?: LINESTATUS
	\where 
		fluid > what? \\
		fluid' = fluid - amount? \\
		line_status' = LINESTATUS
	\end{schema}

\end{document}
